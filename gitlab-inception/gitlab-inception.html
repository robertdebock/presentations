<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <title>GitLab inception</title>
    <link rel="shortcut icon" href="./favicon.ico" />
    <link rel="stylesheet" href="./dist/reset.css" />
    <link rel="stylesheet" href="./dist/reveal.css" />
    <link rel="stylesheet" href="./dist/theme/black.css" id="theme" />
    <link rel="stylesheet" href="./css/highlight/base16/zenburn.css" />


  </head>
  <body>
    <div class="reveal">
      <div class="slides"><section  data-markdown><script type="text/template">

# GitLab inception

Follow along: http://robertdebock.nl/

<img src="https://api.qrserver.com/v1/create-qr-code/?size=350x350&data=http://robertdebock.nl/presentations/gitlab-inception/"/>
</script></section><section  data-markdown><script type="text/template">
# About me

- Father of [3 children](https://raw.githubusercontent.com/robertdebock/presentations/master/images/3.jpg).
- Husband of [1 wife](https://mylucie.com).
- Love to [tinker](https://robertdebock.nl/).
- Specialized in infrastructure.
</script></section><section ><section data-markdown><script type="text/template">
# Tonight

<img height="70%" width="70%" src="https://raw.githubusercontent.com/robertdebock/presentations/master/images/gitlab-inception.png"/>
</script></section><section data-markdown><script type="text/template">
# How?

- Ask questions, get swag.
- https://gitlab.com/robertdebock/gitlab-demo/
- Pseudo-code in presentation.</script></section><section data-markdown><script type="text/template">
# Terraform

Used to:

1. Spin up 1 GitLab instance.
2. Spin up 1+ GitLab runner instance.
3. Sets A-record to the instances.
4. Drop inventory for Ansible to pickup.
</script></section><section data-markdown><script type="text/template">
# Demo Terraform

https://gitlab.com/robertdebock/gitlab-demo/-/pipelines
</script></section><section data-markdown><script type="text/template">
# GitLab instance

```hcl
resource "aws_instance" "gitlab" {
  ami               = data.aws_ami.default.id
  instance_type     = "c5.2xlarge"
  root_block_device {
    volume_size = 8
    volume_type = "gp3"
  }
}
```
</script></section><section data-markdown><script type="text/template">
# GitLab Runner instance

```hcl
resource "aws_instance" "runner" {
  count         = 1
  ami           = data.aws_ami.default.id
  instance_type = "t2.medium"
}
```
</script></section><section data-markdown><script type="text/template">
# A-records

```hcl
data "aws_route53_zone" "default" {
  name         = "aws.adfinis.cloud"
  private_zone = false
}

resource "aws_route53_record" "gitlab" {
  zone_id = data.aws_route53_zone.default.id
  name    = "gitlab.aws.adfinis.cloud"
  type    = "A"
  ttl     = 300
  records = [aws_instance.gitlab.public_ip]
}
```
</script></section><section data-markdown><script type="text/template">
# Inventory

```hcl
resource "local_file" "gitlab" {
  content              = templatefile("templates/gitlab.tpl", { hosts = [aws_route53_record.gitlab.fqdn] })
  filename             = "${path.module}/../ansible/inventory/gitlab"
  directory_permission = "0755"
  file_permission      = "0644"
}
```
</script></section></section><section ><section data-markdown><script type="text/template">
# Ansible

Used to:

1. Install GitLab.
2. Fetch "initial_root_password".
3. Install GitLab Runner.
</script></section><section data-markdown><script type="text/template">
# Demo Ansible

https://gitlab.com/robertdebock/gitlab-demo/-/pipelines
</script></section><section data-markdown><script type="text/template">
# Install GitLab

```yaml
- name: provision gitlab
  hosts: gitlab
  become: yes
  gather_facts: no

  roles:
    - role: robertdebock.users
    - role: robertdebock.cron
    - role: robertdebock.gitlab
```
</script></section><section data-markdown><script type="text/template">
# Ansible role details

- [Users](https://github.com/robertdebock/ansible-role-users)
- [Cron](https://github.com/robertdebock/ansible-role-cron)
- [GitLab](https://github.com/robertdebock/ansible-role-gitlab)
</script></section><section data-markdown><script type="text/template">
# Fetch password

```yaml
post_tasks:
  - name: get initial password
    ansible.builtin.fetch:
      src: /etc/gitlab/initial_root_password
      dest: ../files/initial_root_password
```
</script></section><section data-markdown><script type="text/template">
# Install GitLab Runner

```yaml
- name: provision runner
  hosts: runners
  become: yes
  gather_facts: no

  roles:
    - role: robertdebock.gitlab_runner
```
</script></section><section data-markdown><script type="text/template">
# Ansible role details

- [GitLab runner](https://github.com/robertdebock/ansible-role-gitlab_runner)
</script></section></section><section ><section data-markdown><script type="text/template">
# GitLab

Used to:

1. Run Terraform
2. Run Ansible
</script></section><section data-markdown><script type="text/template">
# Run Terraform

```yaml
apply:
  stage: deploy
  script:
    - gitlab-terraform apply
  artifacts:
    name: ansible
    paths:
      - ansible/inventory/all
      - ansible/inventory/gitlab
      - ansible/inventory/runners
      - files/id_rsa
```
</script></section><section data-markdown><script type="text/template">
# Run Ansible

```yaml
play:
  stage: deploy
  script:
    - ansible-galaxy install -r roles/requirements.yml
    - ./playbook.yml
  artifacts:
    name: gitlab
    paths:
      - files/initial_root_password
```
</script></section></section><section  data-markdown><script type="text/template">
# Relax

<img height="70%" width="70%" src="https://raw.githubusercontent.com/robertdebock/presentations/master/images/gitlab-inception.png"/>
</script></section><section  data-markdown><script type="text/template">
# Improvements

- [ ] Store sensitive information in [Vault](https://www.vaultproject.io).
- [ ] Do not use Ansible at all, just Terraform.
- [ ] Store the runner token securly.
- [ ] CI should cache inventory files.
- [ ] Use https rather than http
</script></section><section  data-markdown><script type="text/template">
# Bonus

Shared state in GitLab.

[<img height="70%" width="70%" src="https://raw.githubusercontent.com/robertdebock/presentations/master/images/gitlab-state.png"/>](https://gitlab.com/robertdebock/gitlab-demo/-/terraform).
</script></section><section  data-markdown><script type="text/template">
# Conclusion

- 3 tools, 3 qualities.
- [Everything](https://github.com/robertdebock/presentations) is code.
- Physical meetups = drinks!
</script></section></div>
    </div>

    <script src="./dist/reveal.js"></script>

    <script src="./plugin/markdown/markdown.js"></script>
    <script src="./plugin/highlight/highlight.js"></script>
    <script src="./plugin/zoom/zoom.js"></script>
    <script src="./plugin/notes/notes.js"></script>
    <script src="./plugin/math/math.js"></script>
    <script>
      function extend() {
        var target = {};
        for (var i = 0; i < arguments.length; i++) {
          var source = arguments[i];
          for (var key in source) {
            if (source.hasOwnProperty(key)) {
              target[key] = source[key];
            }
          }
        }
        return target;
      }

      // default options to init reveal.js
      var defaultOptions = {
        controls: true,
        progress: true,
        history: true,
        center: true,
        transition: 'default', // none/fade/slide/convex/concave/zoom
        plugins: [
          RevealMarkdown,
          RevealHighlight,
          RevealZoom,
          RevealNotes,
          RevealMath
        ]
      };

      // options from URL query string
      var queryOptions = Reveal().getQueryHash() || {};

      var options = extend(defaultOptions, {"controls":false}, queryOptions);
    </script>


    <script>
      Reveal.initialize(options);
    </script>
  </body>
</html>
