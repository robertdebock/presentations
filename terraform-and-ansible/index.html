<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <title>Terraform & Ansible</title>
    <link rel="shortcut icon" href="./favicon.ico" />
    <link rel="stylesheet" href="./dist/reveal.css" />
    <link rel="stylesheet" href="./dist/theme/black.css" id="theme" />
    <link rel="stylesheet" href="./css/highlight/zenburn.css" />


  </head>
  <body>
    <div class="reveal">
      <div class="slides"><section  data-markdown><script type="text/template">

# Terraform and Ansible

Follow along: http://robertdebock.nl/

![QR code to this presentation](https://api.qrserver.com/v1/create-qr-code/?size=350x350&data=http://robertdebock.nl/presentations/terraform-and-ansible/ "Don't worry, you're seeing the presentation already.")
</script></section><section  data-markdown><script type="text/template">
```
                                **
                                *******
        @@@                     ********,**             ,,
       @@#@@                    ********,******.    ,,,,,,
      @@  #@@                      .****,******** ,,,,,,,,
     @@    (@@         &                .******** ,,,,,,,,
    @@ @@@  /@@                          ** ***** ,,,,,
  .@@     @@@(@@                         ****** . .
 .@@         @@@@                        ********
                                         ********
                                            *****
                                                ,
```
</script></section><section  data-markdown><script type="text/template">
# Who am I

- [Robert de Bock](https://robertdebock.nl/).
- Working for [Adfinis](https://adfinis.com/en/).
- [Art-school](https://www.hku.nl/) drop out.
- Loves Linux and open source.
</script></section><section  data-markdown><script type="text/template">
# Contribute

Feel free to [correct mistakes](https://github.com/robertdebock/presentations/blob/master/terraform-and-ansible.md).

![Mistakes have been made](https://i.imgur.com/8zerI4V.png "I can not be wrong.")
</script></section><section ><section data-markdown><script type="text/template">
# Terraform

Can spin up "resources" anywhere.

- Instances
- Loadbalancers
- DNS records
- Volumes
</script></section><section data-markdown><script type="text/template">
# Terraform

Can't really configure instances.

([cloud-init](https://cloudinit.readthedocs.io/en/latest/), or [remote-exec](https://www.terraform.io/docs/provisioners/remote-exec.html) can be used, not configuration management though.)
</script></section><section data-markdown><script type="text/template">
# Ansible

Is simple, used often and has [great roles](https://robertdebock.nl/), but no state.
</script></section></section><section ><section data-markdown><script type="text/template">
# Combining

Terraform and Ansible can work together in a couple of ways.
</script></section><section data-markdown><script type="text/template">
# Terraform local-exec

```
  provisioner "local-exec" {
    command = "ansible-playbook -i '${self.public_ip},' playbook.yml" 
  }
```

Drawback: runs on a single host, no "neighbours", no clusters.
</script></section><section data-markdown><script type="text/template">
```
+----- Terraform ------+           +--- instance ---+
| ansible-playbook ... | -> SSH -> |                |
+----------------------+           +----------------+
```
</script></section><section data-markdown><script type="text/template">
# Terraform "local_file"

Terraform can write an Ansible inventory.

```
# Now save the droplets into an Ansible inventory.
resource "local_file" "inventory" {
  filename = "../ansible/inventory/hosts"
  file_permission = "0644"
  content = <<-EOT
    %{ for ip in digitalocean_droplet.mail.*.ipv4_address ~}${ip}%{ endfor }
  EOT
}
```

Drawback: Does not run the playbook automatically.
</script></section><section data-markdown><script type="text/template">
# Ansible reads Terraform output

Ansible can run Terraform.

Snippets stolen from [ansible-playbook-rancher](https://github.com/robertdebock/ansible-playbook-rancher/blob/master/playbook.yml).
</script></section><section data-markdown><script type="text/template">
# Ansible runs Terraform

```yaml
- name: create machines
  hosts: localhost
  gather_facts: no

  tasks:
    - name: apply terraform code
      terraform:
        project_path: ./terraform
        state: "{{ terraform_state | default('present') }}"
      register: terraform
```
</script></section><section data-markdown><script type="text/template">
# Ansible adds hosts

```yaml
    - name: add terraform hosts to inventory
      add_host:
        name: "{{ item }}"
      loop: "{{ terraform.outputs.name.value }}"
```
</script></section><section data-markdown><script type="text/template">
# Ansible runs

```yaml
- name: configure machines
  hosts: all:!localhost
  gather_facts: no

  roles:
    - role: robertdebock.bootstrap
```
</script></section><section data-markdown><script type="text/template">
# Terraform provider Ansible

There is a community [provider for terraform](https://github.com/nbering/terraform-provider-ansible) that acts as a dynamic inventory.
</script></section></section><section  data-markdown><script type="text/template">
# Anti-patterns

There are a few methods that will cause issues.

1. No combination manual inventory management.
2. Dynamic inventory, too many hosts.
</script></section><section  data-markdown><script type="text/template">
# Conclusion

There are ways to combine Terraform and Ansible, each approach has it's *unique characteristics*.

![Multiple forks, one is broken: Just because you are unique, does not mean you are useful.](https://3.bp.blogspot.com/-XX12ahOZHqY/WUg226Hd0UI/AAAAAAAAkjA/wzFWmJv-EL0DknBcCOi6EPPgQBnHe3AoQCLcBGAs/s1600/unique.jpg "Unique is not always good.")
</script></section></div>
    </div>

    <script src="./dist/reveal.js"></script>

    <script src="./plugin/markdown/markdown.js"></script>
    <script src="./plugin/highlight/highlight.js"></script>
    <script src="./plugin/zoom/zoom.js"></script>
    <script src="./plugin/notes/notes.js"></script>
    <script src="./plugin/math/math.js"></script>
    <script>
      function extend() {
        var target = {};
        for (var i = 0; i < arguments.length; i++) {
          var source = arguments[i];
          for (var key in source) {
            if (source.hasOwnProperty(key)) {
              target[key] = source[key];
            }
          }
        }
        return target;
      }

      // default options to init reveal.js
      var defaultOptions = {
        controls: true,
        progress: true,
        history: true,
        center: true,
        transition: 'default', // none/fade/slide/convex/concave/zoom
        plugins: [
          RevealMarkdown,
          RevealHighlight,
          RevealZoom,
          RevealNotes,
          RevealMath
        ]
      };

      // options from URL query string
      var queryOptions = Reveal().getQueryHash() || {};

      var options = extend(defaultOptions, {"controls":false}, queryOptions);
    </script>


    <script>
      Reveal.initialize(options);
    </script>
  </body>
</html>
