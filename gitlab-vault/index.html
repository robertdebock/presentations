<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <title>GitLab and Vault</title>
    <link rel="shortcut icon" href="./favicon.ico" />
    <link rel="stylesheet" href="./dist/reset.css" />
    <link rel="stylesheet" href="./dist/reveal.css" />
    <link rel="stylesheet" href="./dist/theme/black.css" id="theme" />
    <link rel="stylesheet" href="./css/highlight/base16/zenburn.css" />


  </head>
  <body>
    <div class="reveal">
      <div class="slides"><section  data-markdown><script type="text/template">

# GitLab and Vault

Deploy to AWS without knowing AWS credentials

<img src="https://api.qrserver.com/v1/create-qr-code/?size=350x350&data=http://robertdebock.nl/presentations/gitlab-vault/"/>

# About me

- Father of [3 children](https://raw.githubusercontent.com/robertdebock/presentations/master/images/3.jpg).
- Husband of [1 wife](https://mylucie.com).
- Love to [tinker](https://robertdebock.nl/).
- Specialized in infrastructure.
</script></section><section  data-markdown><script type="text/template">
# What?

GitLab pipelines using Vault to authenticate to AWS.

<img height="50%" width="50%" src="https://raw.githubusercontent.com/robertdebock/presentations/master/images/gitlab-vault.png"/>
</script></section><section  data-markdown><script type="text/template">
# Why?

- Developers don't need AWS credentials.
- Short lived AWS credentials.
</script></section><section ><section data-markdown><script type="text/template">
# How?

1. Create a Vault instance.
2. Configure Vault.
3. Create a GitLab project.
4. Add Terraform files.
5. Have GitLab deploy.
</script></section><section data-markdown><script type="text/template">
# Notes

- Mostly pseudo code in presentation.
</script></section></section><section ><section data-markdown><script type="text/template">
# Create a Vault instance

- A [Vault](https://registry.terraform.io/modules/robertdebock/vault/aws/latest) instance.

In this case I'll spin it up [here](https://github.com/robertdebock/terraform-gitlab-vault/tree/master/vault).
</script></section><section data-markdown><script type="text/template">
# Vault instance details.

- A highly available cluster (3-5)
- Automatically unsealed
- Automatically patched
- With CloudWatch
</script></section></section><section ><section data-markdown><script type="text/template">
# Configure Vault

Vault has two engines that can be used here:

- [JWT](https://developer.hashicorp.com/vault/docs/auth/jwt) authentication engine.
- [AWS](https://developer.hashicorp.com/vault/docs/secrets/aws) secrets engine.
</script></section><section data-markdown><script type="text/template">
# Terraform to configure Vault

```hcl
resource "vault_aws_secret_backend" "default" {
  description               = "AWS secret engine."
  path                      = "aws"
  access_key                = var.aws_access_key
  secret_key                = var.aws_secret_key
  default_lease_ttl_seconds = 300
  max_lease_ttl_seconds     = 600
}
```

See [here](https://github.com/robertdebock/terraform-gitlab-vault/blob/master/main.tf).
</script></section></section><section  data-markdown><script type="text/template">
## Create a GitLab project

```hcl
# Make a GitLab project.
resource "gitlab_project" "default" {
  name                   = "vault-aws-demo"
  description            = "A demo to use HashiCorp Vault in a GitLab pipeline."
  default_branch         = "main"
  shared_runners_enabled = false
  visibility_level       = "public"
  depends_on             = [vault_jwt_auth_backend.default]
}
```
</script></section><section  data-markdown><script type="text/template"># Add Terraform files

In this case using Terraform. Normally for developers.

```hcl
# Add a Terraform file to the GitLab project.
resource "gitlab_repository_file" "maintf" {
  project        = gitlab_project.default.id
  file_path      = "main.tf"
  branch         = "main"
  content        = base64encode(file("${path.module}/files/main.tf"))
  author_email   = "robert@meinit.nl"
  author_name    = "Robert de Bock"
  commit_message = "Add main.tf."
}
```
</script></section><section  data-markdown><script type="text/template"># Have GitLab deploy

GitLab pipeline is authenticated to deploy.
</script></section><section  data-markdown><script type="text/template">
Set variables described in [README](https://github.com/robertdebock/terraform-gitlab-vault/blob/master/README.md#setup).

`terraform apply` to:

- Configure Vault
- Create a GitLab repository
</script></section><section  data-markdown><script type="text/template">
# Conclusion

- A developer does not need AWS credentials.
- Short lived secrets can leak.
- Same for [DBs](https://developer.hashicorp.com/vault/tutorials/db-credentials/database-secrets) [Azure](https://developer.hashicorp.com/vault/docs/secrets/azure), [GCP](https://developer.hashicorp.com/vault/docs/secrets/gcp), and others.
</script></section></div>
    </div>

    <script src="./dist/reveal.js"></script>

    <script src="./plugin/markdown/markdown.js"></script>
    <script src="./plugin/highlight/highlight.js"></script>
    <script src="./plugin/zoom/zoom.js"></script>
    <script src="./plugin/notes/notes.js"></script>
    <script src="./plugin/math/math.js"></script>
    <script>
      function extend() {
        var target = {};
        for (var i = 0; i < arguments.length; i++) {
          var source = arguments[i];
          for (var key in source) {
            if (source.hasOwnProperty(key)) {
              target[key] = source[key];
            }
          }
        }
        return target;
      }

      // default options to init reveal.js
      var defaultOptions = {
        controls: true,
        progress: true,
        history: true,
        center: true,
        transition: 'default', // none/fade/slide/convex/concave/zoom
        plugins: [
          RevealMarkdown,
          RevealHighlight,
          RevealZoom,
          RevealNotes,
          RevealMath
        ]
      };

      // options from URL query string
      var queryOptions = Reveal().getQueryHash() || {};

      var options = extend(defaultOptions, {"controls":false}, queryOptions);
    </script>


    <script>
      Reveal.initialize(options);
    </script>
  </body>
</html>
